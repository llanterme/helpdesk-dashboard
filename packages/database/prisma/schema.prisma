// This is your Prisma schema file,
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  role      UserRole @default(AGENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  agent Agent?

  @@map("users")
}

model Agent {
  id             String      @id @default(cuid())
  userId         String?     @unique
  name           String
  email          String      @unique
  phone          String?
  role           AgentRole   @default(AGENT)
  avatar         String?
  color          String?
  commissionRate Float       @default(50.0)
  status         AgentStatus @default(ACTIVE)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relations
  user     User?     @relation(fields: [userId], references: [id])
  tickets  Ticket[]
  quotes   Quote[]
  invoices Invoice[]
  bills    Bill[]

  @@map("agents")
}

model Client {
  id          String   @id @default(cuid())
  name        String
  email       String   @unique
  phone       String?
  whatsappId  String?  @unique // WhatsApp phone ID (without +)
  company     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Zoho Integration IDs
  zohoCrmContactId   String?    @unique // Zoho CRM Contact ID
  zohoBooksContactId String?    @unique // Zoho Books Contact ID
  zohoSyncedAt       DateTime?  // Last sync timestamp
  zohoSyncStatus     SyncStatus @default(PENDING)
  zohoSyncError      String?    @db.Text

  // Relations
  tickets  Ticket[]
  quotes   Quote[]
  invoices Invoice[]

  @@map("clients")
}

model Service {
  id          String   @id @default(cuid())
  name        String
  category    String
  description String?
  rate        Float
  unit        String   @default("per item")
  sku         String   @unique
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Zoho Books Integration
  zohoBooksItemId String?    @unique // Zoho Books Item ID
  zohoSyncedAt    DateTime?  // Last sync timestamp
  zohoSyncStatus  SyncStatus @default(PENDING)

  // Relations
  quoteItems   QuoteItem[]
  invoiceItems InvoiceItem[]

  @@map("services")
}

model Ticket {
  id        String        @id @default(cuid())
  subject   String
  channel   TicketChannel
  status    TicketStatus  @default(OPEN)
  priority  TicketPriority @default(MEDIUM)
  unread    Boolean       @default(true)
  clientId  String
  agentId   String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  // Relations
  client   Client    @relation(fields: [clientId], references: [id])
  agent    Agent?    @relation(fields: [agentId], references: [id])
  messages Message[]

  @@map("tickets")
}

model Message {
  id         String        @id @default(cuid())
  ticketId   String
  senderType SenderType
  senderId   String?
  content    String        @db.Text
  timestamp  DateTime      @default(now())
  read       Boolean       @default(false)

  // WhatsApp-specific fields
  whatsappMessageId String?       // WhatsApp message ID for tracking
  whatsappStatus    MessageStatus? // sent, delivered, read, failed
  mediaUrl          String?       // URL for media attachments
  mediaType         String?       // image, document, audio, video

  // Relations
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@map("messages")
}

enum MessageStatus {
  SENT
  DELIVERED
  READ
  FAILED
}

model Quote {
  id             String      @id @default(cuid())
  number         String      @unique
  clientId       String
  agentId        String?
  status         QuoteStatus @default(DRAFT)
  subtotal       Float       @default(0)
  taxRate        Float       @default(15.0) // South African VAT rate
  taxAmount      Float       @default(0)
  discountRate   Float       @default(0)
  discountAmount Float       @default(0)
  totalAmount    Float       @default(0)
  notes          String?     @db.Text
  terms          String?     @db.Text
  validUntil     DateTime?
  sentAt         DateTime?
  acceptedAt     DateTime?
  expiredAt      DateTime?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Zoho Books Integration
  zohoBooksEstimateId String?    @unique // Zoho Books Estimate ID
  zohoCrmDealId       String?    @unique // Zoho CRM Deal ID
  zohoSyncedAt        DateTime?  // Last sync timestamp
  zohoSyncStatus      SyncStatus @default(PENDING)
  zohoSyncError       String?    @db.Text

  // Relations
  client     Client            @relation(fields: [clientId], references: [id])
  agent      Agent?            @relation(fields: [agentId], references: [id])
  items      QuoteItem[]
  statusLogs QuoteStatusLog[]
  invoice    Invoice?

  @@map("quotes")
}

model QuoteItem {
  id                String  @id @default(cuid())
  quoteId           String
  serviceId         String
  quantity          Int     @default(1)
  rate              Float
  lineTotal         Float
  customDescription String? // Optional custom description override

  // Relations
  quote   Quote   @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id])

  @@map("quote_items")
}

model QuoteStatusLog {
  id       String      @id @default(cuid())
  quoteId  String
  status   QuoteStatus
  changedBy String?     // Agent ID who made the change
  notes    String?     @db.Text
  createdAt DateTime   @default(now())

  // Relations
  quote Quote @relation(fields: [quoteId], references: [id], onDelete: Cascade)

  @@map("quote_status_logs")
}

model Invoice {
  id          String        @id @default(cuid())
  number      String?       @unique // Invoice number (e.g., INV-000001)
  quoteId     String?       @unique
  clientId    String
  agentId     String?
  status      InvoiceStatus @default(PENDING)
  subtotal    Float         @default(0)
  taxRate     Float         @default(15.0)
  taxAmount   Float         @default(0)
  totalAmount Float
  dueDate     DateTime?
  paidDate    DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Zoho Books Integration
  zohoBooksInvoiceId String?    @unique // Zoho Books Invoice ID
  zohoSyncedAt       DateTime?  // Last sync timestamp
  zohoSyncStatus     SyncStatus @default(PENDING)
  zohoSyncError      String?    @db.Text
  zohoPaymentId      String?    // Zoho Books Payment ID (when paid)

  // Relations
  quote  Quote?        @relation(fields: [quoteId], references: [id])
  client Client        @relation(fields: [clientId], references: [id])
  agent  Agent?        @relation(fields: [agentId], references: [id])
  items  InvoiceItem[]
  bill   Bill?

  @@map("invoices")
}

model InvoiceItem {
  id        String  @id @default(cuid())
  invoiceId String
  serviceId String
  quantity  Int     @default(1)
  rate      Float
  lineTotal Float

  // Relations
  invoice Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id])

  @@map("invoice_items")
}

model Bill {
  id          String     @id @default(cuid())
  invoiceId   String     @unique
  agentId     String
  totalAmount Float
  status      BillStatus @default(DRAFT)
  createdAt   DateTime   @default(now())
  paidDate    DateTime?

  // Relations
  invoice Invoice   @relation(fields: [invoiceId], references: [id])
  agent   Agent     @relation(fields: [agentId], references: [id])
  items   BillItem[]

  @@map("bills")
}

model BillItem {
  id             String @id @default(cuid())
  billId         String
  serviceName    String
  quantity       Int
  commissionRate Float
  lineTotal      Float

  // Relations
  bill Bill @relation(fields: [billId], references: [id], onDelete: Cascade)

  @@map("bill_items")
}

// Enums
enum UserRole {
  ADMIN
  AGENT
}

enum AgentRole {
  ADMIN
  SENIOR_AGENT
  AGENT
}

enum AgentStatus {
  ACTIVE
  INACTIVE
}

enum TicketChannel {
  WHATSAPP
  EMAIL
  FORM
  CHAT
}

enum TicketStatus {
  OPEN
  PENDING
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

enum SenderType {
  CLIENT
  AGENT
}

enum QuoteStatus {
  DRAFT
  SENT
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum InvoiceStatus {
  PENDING
  SENT
  PAID
  OVERDUE
}

enum BillStatus {
  DRAFT
  SENT
  PAID
}

enum SyncStatus {
  PENDING
  SYNCED
  FAILED
  CONFLICT
}

enum SyncDirection {
  TO_ZOHO
  FROM_ZOHO
}

// Sync audit log for tracking all Zoho synchronization
model SyncLog {
  id           String        @id @default(cuid())
  entityType   String        // 'client', 'service', 'quote', 'invoice'
  entityId     String
  direction    SyncDirection
  status       String        // 'success', 'failed', 'skipped'
  zohoId       String?
  errorMessage String?       @db.Text
  requestBody  Json?
  responseBody Json?
  createdAt    DateTime      @default(now())

  @@index([entityType, entityId])
  @@index([createdAt])
  @@map("sync_logs")
}